# UltAssist V2 需求文档

## 项目概述

UltAssist 是一个为永劫无间游戏开发的音乐辅助工具。V2 版本将功能从"大招识别播放音乐"扩展为"多按键音乐映射系统"，让玩家可以为各种游戏操作配置对应的音乐效果。

## 核心功能变更

### 从 V1 到 V2 的主要变化
- **V1**：热键触发 + 视觉识别大招 + 播放音乐
- **V2**：多按键映射 + 即时音乐播放 + 灵活配置

### 变更原因
1. 大招识别实现复杂（需要大量图片标注）
2. 识别准确性不是核心需求
3. 扩展到多种按键操作更实用有趣

## 详细功能需求

### 1. 界面布局设计

界面分为三个主要区域：

```
┌─────────────────────────────────────┐
│ 全局配置区域                          │
│ • 设备选择：播放设备 + 虚拟设备        │
│ • 监听范围：仅游戏窗口 / 全局监听      │
│ • 全局开关：Ctrl+1 快捷键            │
│ • 指示栏样式：无/开启关闭状态/调试面板  │
│ • 指示栏位置：左上角/右上角/中间顶部   │
├─────────────────────────────────────┤
│ 配置切换&修改区域                      │
│ • 英雄配置选择器                      │
│ • 配置管理：[复制配置][导入][导出]      │
│ • 按键映射列表                        │
│ • [添加新映射] 按钮                   │
│ ┌─按键映射项─────────────────────┐    │
│ │ Ctrl+C → music1.mp3           │    │
│ │ 设置: 淡入200ms 循环 可打断     │    │
│ │ [测试播放] [编辑] [删除]        │    │
│ └──────────────────────────────┘    │
├─────────────────────────────────────┤
│ 自动截图辅助区域                      │
│ • ROI 相关功能（为将来扩展保留）       │
└─────────────────────────────────────┘
```

### 2. 全局配置区域

#### 2.1 设备选择
- **播放设备**：用户自己听到的音频输出设备
- **虚拟设备**：输出到队友的虚拟麦克风设备
- 保持 V1 的双路输出逻辑

#### 2.2 监听范围配置
- **仅游戏窗口**：只在永劫无间窗口激活时监听按键
- **全局监听**：在任何窗口都监听按键
- 游戏窗口识别：通过进程名称识别永劫无间

#### 2.3 全局开关
- **快捷键**：Ctrl+1
- **功能**：开启/关闭整个按键监听功能
- **行为**：关闭时停止所有正在播放的音频，再次开启时不自动恢复播放

#### 2.4 顶部指示栏配置
- **样式选项**：
  - **无**：不显示指示栏
  - **开启/关闭状态**：仅显示当前是否开启监听
  - **调试面板**：显示详细调试信息
- **位置选项**：左上角 / 右上角 / 中间顶部
- **显示方式**：常驻显示
- **外观**：带图标的彩色条

#### 2.5 调试面板内容
显示以下信息：
- 当前是否开启监听
- 当前正在播放的音乐文件名
- 上一次监听到的按键及按下时间

### 3. 配置切换&修改区域

#### 3.1 英雄配置管理
- **配置切换**：下拉选择器切换不同英雄配置
- **配置操作**：
  - **复制配置**：从一个英雄复制配置到另一个英雄
  - **导入配置**：从文件导入配置
  - **导出配置**：将当前配置导出到文件
  - **重命名配置**：修改英雄配置名称
  - **删除配置**：删除当前英雄配置

#### 3.2 按键映射配置
每个英雄配置包含多个"按键→音乐"的映射关系。

##### 3.2.1 支持的按键类型
- **键盘按键**：所有键盘按键
- **鼠标按键**：左键、右键、中键（滚轮点击）、侧键（前进/后退）
- **组合键**：支持 Ctrl、Shift、Alt 与其他键的组合
- **不支持**：鼠标滚轮滚动事件

##### 3.2.2 按键录制流程
```
[添加新映射] → [录制按键 📹] → 用户按下组合键 → 显示"检测到: Ctrl+C" → [确认] → 配置音乐参数
```

##### 3.2.3 音乐配置参数
每个按键映射包含以下配置：
- **音乐文件**：支持常见音频格式（mp3、wav、flac、m4a、ogg）
- **淡入时间**：音乐开始时的淡入效果时长（毫秒）
- **淡出时间**：音乐结束时的淡出效果时长（毫秒）
- **是否循环**：音乐是否循环播放
- **是否可打断**：当按下新按键时，是否可以打断当前正在播放的音乐

##### 3.2.4 按键映射操作
- **测试播放**：点击后模拟按键效果，播放对应音乐
- **编辑配置**：修改音乐文件和播放参数
- **删除映射**：移除该按键映射配置

### 4. 音乐播放逻辑

#### 4.1 打断逻辑
- 当用户按下新按键时：
  - 检查当前正在播放的音乐是否标记为"可打断"
  - 如果可打断：停止当前音乐，播放新音乐
  - 如果不可打断：忽略新按键，继续播放当前音乐

#### 4.2 重复按键处理
- 对同一按键的重复按下，采用与不同按键相同的打断逻辑

#### 4.3 音频输出
- 保持 V1 的双路输出：同时输出到播放设备和虚拟设备
- 支持淡入淡出效果
- 支持音量限幅，防止炸麦

### 5. 自动截图辅助区域

保留现有的 ROI 相关功能，为将来的功能扩展做准备。移除所有与"自动标注"相关的功能。

## 技术实现要求

### 1. 技术栈
- **平台**：Windows (.NET 8)
- **UI框架**：WPF
- **音频库**：NAudio（双路输出、淡入淡出、循环、限幅）
- **按键监听**：全局钩子 + 游戏窗口检测
- **配置存储**：JSON 文件

### 2. 按键监听实现
- **全局钩子**：使用 Windows API 实现全局按键监听
- **窗口检测**：通过进程名称识别永劫无间游戏窗口
- **组合键识别**：正确识别和记录组合键状态

### 3. 顶部指示栏实现
- **悬浮窗口**：WPF 顶层窗口，始终置顶
- **位置计算**：根据用户设置计算屏幕位置
- **样式设计**：带图标的彩色条样式
- **实时更新**：监听状态变化，实时更新显示内容

### 4. 配置管理
- **文件格式**：JSON 格式存储配置
- **导入导出**：支持配置文件的导入导出
- **配置验证**：加载配置时验证完整性和有效性

## 实现优先级

### Phase 1: 核心重构
1. **配置模型重构**：从大招配置改为按键映射配置
2. **按键监听系统**：实现全局钩子和游戏窗口检测
3. **UI界面重构**：重新设计三个区域的布局

### Phase 2: 功能实现
4. **音乐播放控制**：实现打断逻辑和状态管理
5. **按键录制界面**：实现按键录制和识别功能
6. **顶部指示栏**：实现悬浮指示栏功能

### Phase 3: 完善功能
7. **配置管理**：实现导入导出和复制功能
8. **测试和优化**：完善边界情况处理
9. **用户体验优化**：界面细节和交互优化

## 兼容性考虑

### 1. 配置迁移
- V1 配置文件需要迁移到 V2 格式
- 保持向后兼容，避免用户配置丢失

### 2. 设备管理
- 保持现有的音频设备选择和管理逻辑
- 确保程序退出时不影响系统默认音频设置

## 用户体验目标

1. **简单易用**：直观的界面布局，清晰的操作流程
2. **功能丰富**：支持多种按键和音乐配置
3. **稳定可靠**：准确的按键识别，稳定的音频播放
4. **性能优秀**：低资源占用，快速响应
5. **安全合规**：不涉及游戏内存读写，避免封号风险

## 总结

UltAssist V2 通过将功能从特定的大招识别扩展为通用的按键音乐映射系统，大大提升了产品的实用性和灵活性。用户可以为各种游戏操作配置个性化的音效，创造更丰富的游戏体验。